# 文件寄存器 UI 功能说明

## 更新内容

UI 界面已添加完整的文件寄存器支持，通过 Tab 标签页组织功能。

## 界面布局

### 主界面分为两个标签页：

1. **标准数据** - 线圈、离散输入、保持寄存器、输入寄存器
2. **文件寄存器** - 标准文件记录和地址文件操作

## 文件寄存器功能

### 1. 标准文件记录（功能码 20/21）

#### 控件说明：
- **文件号**: 0-65535，选择要操作的文件
- **记录号**: 0-9999，文件内的记录起始位置
- **记录数**: 1-100，要读取/写入的记录数量

#### 操作按钮：
- **读取文件**: 模拟功能码 20（读文件记录）操作
- **写入测试数据**: 模拟功能码 21（写文件记录）操作

#### 使用示例：
```
文件号: 1
记录号: 0
记录数: 10
→ 点击"读取文件"查看文件1的前10条记录
```

### 2. 地址文件（功能码 203/204）

#### 控件说明：
- **起始地址**: 0-65535，寄存器起始地址
- **寄存器数**: 1-125，要读取/写入的寄存器数量

#### 操作按钮：
- **读取地址文件**: 模拟功能码 203（自定义读文件）操作
- **写入测试数据**: 模拟功能码 204（自定义写文件）操作

#### 使用示例：
```
起始地址: 1000
寄存器数: 20
→ 点击"读取地址文件"查看地址1000-1019的数据
```

## 预初始化的文件

初始化数据后会创建以下文件：

| 文件号 | 描述 | 记录数 |
|--------|------|--------|
| 1 | 温度数据文件 | 256 |
| 2 | 状态数据文件 | 128 |

地址存储区域：
- 地址范围: 1000-1199
- 总计: 200 个寄存器

## 功能码对照表

| 功能码 | 名称 | UI 操作 |
|--------|------|---------|
| 20 (0x14) | 读文件记录 | 标准文件记录 → 读取文件 |
| 21 (0x15) | 写文件记录 | 标准文件记录 → 写入测试数据 |
| 203 (0xCB) | 读地址文件 | 地址文件 → 读取地址文件 |
| 204 (0xCC) | 写地址文件 | 地址文件 → 写入测试数据 |

## 使用流程

### 快速测试文件寄存器：

1. **启动服务器**
   ```
   点击"初始化数据" → 点击"启动 TCP"
   ```

2. **查看标准文件记录**
   ```
   切换到"文件寄存器"标签页
   文件号: 1
   记录号: 0
   记录数: 10
   点击"读取文件"
   ```

3. **写入测试数据**
   ```
   保持相同设置
   点击"写入测试数据"
   ```

4. **查看地址文件**
   ```
   起始地址: 1000
   寄存器数: 20
   点击"读取地址文件"
   ```

## 与 Modbus 客户端交互

### 使用 pymodbus 测试文件记录：

```python
from pymodbus.client import ModbusTcpClient

client = ModbusTcpClient('127.0.0.1', port=502)
client.connect()

# 功能码 20 - 读文件记录
# 构造请求: [字节数][参考类型=6][文件号][记录号][记录长度]
request = bytes([
    0x14,  # 功能码 20
    0x07,  # 字节数
    0x06,  # 参考类型
    0x00, 0x01,  # 文件号 1
    0x00, 0x00,  # 记录号 0
    0x00, 0x0A   # 记录长度 10
])

# 发送原始请求
from pymodbus.pdu import ModbusRequest
response = client.execute(ModbusRequest(function_code=0x14))

# 功能码 21 - 写文件记录
# 构造写入数据
write_data = bytes([
    0x15,  # 功能码 21
    0x0D,  # 字节数 (7 + 6个字节数据)
    0x06,  # 参考类型
    0x00, 0x01,  # 文件号 1
    0x00, 0x00,  # 记录号 0
    0x00, 0x03,  # 记录长度 3
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB  # 3条记录数据
])

client.close()
```

### 使用 Modbus Poll 测试：

1. **读文件记录（功能码 20）**
   - Function: Read File Record (20)
   - File Number: 1
   - Record Number: 0
   - Record Length: 10

2. **读地址文件（功能码 203）**
   - Function: User Defined (203)
   - Starting Address: 1000
   - Quantity: 20

## 注意事项

1. **UI 模拟操作**
   - UI 中的"读取"和"写入"按钮是模拟操作，显示预期的数据格式
   - 实际的文件读写需要通过 Modbus 客户端工具发送请求

2. **功能码支持**
   - 服务器后端已完整实现所有文件功能码
   - 可以接收并处理真实的 Modbus 客户端请求

3. **数据持久化**
   - 当前版本数据仅保存在内存中
   - 重启程序后数据会丢失，需重新初始化

4. **日志监控**
   - 所有文件操作都会记录到日志区域
   - 实际的 Modbus 请求会显示真实的功能码

## 界面截图说明

主界面布局：
```
┌─────────────────────────────────────────────┐
│         Modbus TCP/RTU 从站服务器            │
├─────────────────────────────────────────────┤
│ [服务器控制]  TCP/RTU 启动停止              │
├─────────────────────────────────────────────┤
│ [服务器状态]  运行状态、模式、请求计数      │
├─────────────────────────────────────────────┤
│ [数据监控与文件寄存器]                      │
│  ┌─────────────┬──────────────────┐         │
│  │ 标准数据 │ 文件寄存器 │                 │
│  └─────────────┴──────────────────┘         │
│  ┌───────────────────────────────┐          │
│  │ • 标准文件记录 (FC 20/21)    │          │
│  │   文件号、记录号、记录数      │          │
│  │   [读取文件] [写入测试数据]  │          │
│  │                                │          │
│  │ • 地址文件 (FC 203/204)       │          │
│  │   起始地址、寄存器数          │          │
│  │   [读取] [写入]               │          │
│  │                                │          │
│  │ [文件数据显示区域]            │          │
│  └───────────────────────────────┘          │
├─────────────────────────────────────────────┤
│ [日志]  操作记录和请求日志                  │
└─────────────────────────────────────────────┘
```

## 扩展建议

如需进一步增强功能，可以考虑：

1. 添加文件创建功能（自定义文件号和大小）
2. 实现数据持久化（保存到文件）
3. 添加十六进制数据编辑器
4. 支持批量文件操作
5. 添加数据导入/导出功能

---

更新完成！现在可以通过 UI 界面完整测试文件寄存器功能。
